<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éšœå®³é¦¬æŸ±åˆ†æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1b4332; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; font-size: 13px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        .card { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        label { display: block; font-size: 10px; font-weight: bold; color: #666; margin-bottom: 2px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }

        .record-fixed-area { grid-column: span 2; background: #f8f9fa; border-left: 4px solid var(--primary); padding: 8px; border-radius: 4px; margin: 4px 0; font-size: 12px; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }

        .outer-scroll { width: 100%; overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; padding: 5px; }
        .horse-table { border-collapse: collapse; min-width: 950px; width: 100%; background: white; }
        .th-slot { font-size: 13px; font-weight: bold; background: #f1f3f1; color: #1b4332; padding: 10px 5px; border-bottom: 2px solid #ddd; }
        
        .horse-info-cell { position: sticky; left: 0; z-index: 10; background: #333; color: white; width: 120px; min-width: 120px; padding: 8px; text-align: center; border-bottom: 1px solid #444; border-right: 2px solid #111; }
        .h-num-badge { background: #fff; color: #000; padding: 1px 6px; border-radius: 4px; font-weight: bold; margin-right: 4px; }

        .race-td { border-bottom: 1px solid #eee; border-right: 1px solid #ddd; width: 160px; min-width: 160px; padding: 0; vertical-align: top; }
        .race-box { padding: 8px 6px; text-align: center; position: relative; min-height: 140px; }
        
        /* ãƒ¬ãƒ¼ã‚¹åã‚’å›²ã‚€ã‚¹ã‚¿ã‚¤ãƒ« */
        .r-note { font-size: 11px; font-weight: bold; height: 32px; display: flex; align-items: center; justify-content: center; line-height: 1.2; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 4px; padding: 2px; background: #fafafa; }
        
        /* æ¡ä»¶ã¯ã‚·ãƒ³ãƒ—ãƒ«ã« */
        .r-cond { font-size: 11px; color: #666; margin-bottom: 4px; display: block; }

        .r-time { font-size: 16px; font-weight: bold; margin: 2px 0; }
        .r-abort { color: #d32f2f; font-weight: bold; font-size: 16px; margin: 2px 0; }
        .r-sub-info { font-size: 12px; display: flex; justify-content: center; gap: 4px; align-items: center; margin-top: 2px; }
        .badge-cond { color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; }
        .badge-weight { color: #444; font-size: 11px; font-weight: bold; }
        
        .rank-badge { min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 13px; }
        .rank-1 { background: #ffd700; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .rank-2 { background: #c0c0c0; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .rank-3 { background: #cd7f32; color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .rank-other { color: #333; }

        .r-ratio { font-size: 14px; font-weight: bold; padding: 3px; border-radius: 4px; border: 1px solid #eee; display: block; margin-top: 5px; }

        .best-yellow { background: #fef08a; color: #854d0e; border-color: #fde047; } 
        .best-blue { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }   
        .best-orange { background: #ffedd5; color: #9a3412; border-color: #fed7aa; } 

        .accordion-btn { width: 100%; padding: 10px; background: #ddd; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: left; margin-bottom: 5px; }
        .accordion-content { display: none; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; font-size: 11px; }

        .admin-block { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .admin-btn { padding: 10px; border-radius: 4px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body>

<div id="toast">ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ</div>

<div class="container">
    <div id="inputArea" class="card">
        <div class="input-grid">
            <div><label>é¦¬ç•ª</label><input type="number" id="hNum" tabindex="1"></div>
            <div><label>é¦¬å</label><input type="text" id="hName" tabindex="2"></div>
            <div style="grid-column: span 2;"><label>ãƒ¬ãƒ¼ã‚¹å</label><input type="text" id="rNote" tabindex="3" placeholder="ä¾‹ï¼šä¸­å±±å¤§éšœå®³"></div>
            <div><label>ç«¶é¦¬å ´</label><select id="venue" onchange="updateCourse()" tabindex="4"><option value="">é¸æŠ</option><option value="nakayama">ä¸­å±±</option><option value="tokyo">æ±äº¬</option><option value="kyoto">äº¬éƒ½</option><option value="hanshin">é˜ªç¥</option><option value="niigata">æ–°æ½Ÿ</option><option value="kokura">å°å€‰</option><option value="fukushima">ç¦å³¶</option><option value="chukyo">ä¸­äº¬</option></select></div>
            <div><label>è·é›¢</label><select id="course" onchange="updateRecordDisplay()" tabindex="5"></select></div>
            <div id="recInfo" class="record-fixed-area">å ´æ‰€ã¨è·é›¢ã‚’é¸æŠ</div>
            <div><label>é¦¬å ´çŠ¶æ…‹</label><select id="rTrack" tabindex="6"><option value="è‰¯">è‰¯</option><option value="ç¨">ç¨é‡</option><option value="é‡">é‡</option><option value="ä¸">ä¸è‰¯</option></select></div>
            <div><label>ç€é †</label><input type="text" id="rRank" tabindex="7"></div>
            <div><label>æ–¤é‡</label><input type="text" id="rWeight" tabindex="8" placeholder="60"></div>
            <div><label>ã‚¿ã‚¤ãƒ  (ä¸­æ­¢=0)</label><input type="text" id="rTime" tabindex="9" placeholder="318.1"></div>
            <div style="grid-column: span 2; display: flex; gap: 4px; margin-top: 5px;">
                <button class="slot-btn" id="s0" style="flex:1; padding:8px; background:var(--primary); color:white;" onclick="setSlot(0)">1èµ°å‰</button>
                <button class="slot-btn" id="s1" style="flex:1; padding:8px; background:#eee;" onclick="setSlot(1)">2èµ°å‰</button>
                <button class="slot-btn" id="s2" style="flex:1; padding:8px; background:#eee;" onclick="setSlot(2)">3èµ°å‰</button>
                <button class="slot-btn" id="s3" style="flex:1; padding:8px; background:#eee;" onclick="setSlot(3)">4èµ°å‰</button>
                <button class="slot-btn" id="s4" style="flex:1; padding:8px; background:#eee;" onclick="setSlot(4)">5èµ°å‰</button>
            </div>
        </div>
        <button onclick="addEntry()" style="width:100%; margin-top:10px; padding:15px; background:var(--primary); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;" tabindex="10">ç™»éŒ² / ä¸Šæ›¸ã</button>
    </div>

    <div id="captureArea" style="background: white; padding: 5px;">
        <div class="outer-scroll">
            <table class="horse-table">
                <thead>
                    <tr>
                        <th class="horse-info-cell">é¦¬ç•ª / é¦¬å</th>
                        <th class="th-slot">1èµ°å‰</th>
                        <th class="th-slot">2èµ°å‰</th>
                        <th class="th-slot">3èµ°å‰</th>
                        <th class="th-slot">4èµ°å‰</th>
                        <th class="th-slot">5èµ°å‰</th>
                    </tr>
                </thead>
                <tbody id="hTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="admin-block">
        <button class="admin-btn" style="background:#2a6fdb" onclick="downloadJSON()">ğŸ“¤ ä¿å­˜</button>
        <button class="admin-btn" style="background:#34495e" onclick="document.getElementById('fileInput').click()">ğŸ“¥ èª­è¾¼</button>
        <button class="admin-btn" style="background:#e74c3c; grid-column:span 2; margin-top:5px;" onclick="clearAll()">ğŸ’¥ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ï¼ˆç™»éŒ²ã§ããªã„æ™‚ã‚‚ã“ã¡ã‚‰ï¼‰</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
    </div>

    <div style="margin-top: 20px;">
        <button class="accordion-btn" onclick="toggleAccordion()">â–¼ éšœå®³ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§</button>
        <div id="dbList" class="accordion-content"></div>
    </div>
</div>

<script>
const db = {
    nakayama: { label: "ä¸­å±±", data: [{ name: "èŠ4260m", record: 290.5 }, { name: "èŠ4250m", record: 283.0 }, { name: "èŠ4100m", record: 276.1 }, { name: "èŠ3570m", record: 237.9 }, { name: "ãƒ€3550m", record: 238.1 }, { name: "èŠ3370m", record: 225.4 }, { name: "èŠ3350m", record: 220.8 }, { name: "èŠ3210m", record: 209.3 }, { name: "ãƒ€3200m", record: 211.0 }, { name: "èŠ3030m", record: 200.3 }, { name: "ãƒ€2880m", record: 190.2 }, { name: "èŠ2710m", record: 182.2 }, { name: "ãƒ€2700m", record: 176.8 }] },
    kyoto: { label: "äº¬éƒ½", data: [{ name: "èŠ3930m", record: 261.6 }, { name: "ãƒ€3790m", record: 255.0 }, { name: "ãƒ€3760m", record: 254.4 }, { name: "ãƒ€3190m", record: 211.5 }, { name: "èŠ3180m", record: 213.5 }, { name: "èŠ3170m", record: 210.4 }, { name: "ãƒ€3170m", record: 208.4 }, { name: "ãƒ€2930m", record: 192.2 }, { name: "ãƒ€2910m", record: 191.2 }] },
    tokyo: { label: "æ±äº¬", data: [{ name: "èŠ3300m", record: 215.1 }, { name: "ãƒ€3300m", record: 216.2 }, { name: "èŠ3110m", record: 203.6 }, { name: "ãƒ€3100m", record: 202.0 }, { name: "ãƒ€3000m", record: 197.5 }] },
    hanshin: { label: "é˜ªç¥", data: [{ name: "èŠ3900m", record: 259.1 }, { name: "èŠ3800m", record: 258.1 }, { name: "èŠ3140m", record: 204.8 }, { name: "ãƒ€3110m", record: 205.0 }, { name: "ãƒ€2970m", record: 195.7 }] },
    niigata: { label: "æ–°æ½Ÿ", data: [{ name: "èŠ3290m", record: 214.4 }, { name: "èŠ3250m", record: 208.3 }, { name: "èŠ2890m", record: 185.5 }, { name: "èŠ2850m", record: 181.4 }] },
    kokura: { label: "å°å€‰", data: [{ name: "èŠ3390m", record: 220.0 }, { name: "èŠ2900m", record: 187.1 }, { name: "èŠ2860m", record: 186.3 }] },
    fukushima: { label: "ç¦å³¶", data: [{ name: "èŠ3380m", record: 218.5 }, { name: "èŠ3350m", record: 219.0 }, { name: "èŠ2800m", record: 181.8 }, { name: "èŠ2770m", record: 179.3 }, { name: "èŠ2750m", record: 177.2 }] },
    chukyo: { label: "ä¸­äº¬", data: [{ name: "èŠ3900m", record: 254.8 }, { name: "èŠ3330m", record: 217.4 }, { name: "èŠ3300m", record: 213.3 }, { name: "èŠ3000m", record: 195.8 }] }
};

let horses = {};
let currentSlot = 0;
const STORAGE_KEY = 'horse_v14_data';

window.onload = () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) {
        try { horses = JSON.parse(saved); render(); } catch(e) { console.error("Data load error"); }
    }
    initDb();
};

function initDb() {
    const list = document.getElementById('dbList');
    let html = "";
    for(let v in db){
        db[v].data.forEach(d => {
            html += `<div style="display:flex;justify-content:space-between;padding:3px;border-bottom:1px solid #eee;"><span>${db[v].label} ${d.name}</span><b>${Math.floor(d.record/60)}:${(d.record%60).toFixed(1).padStart(4,'0')}</b></div>`;
        });
    }
    list.innerHTML = html;
}

function toggleAccordion() {
    const content = document.getElementById('dbList');
    content.style.display = (content.style.display === 'block') ? 'none' : 'block';
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.opacity = "1";
    setTimeout(() => { t.style.opacity = "0"; }, 2000);
}

function setSlot(n) {
    currentSlot = n;
    document.querySelectorAll('.slot-btn').forEach((b,i) => {
        b.style.background = (i === n) ? 'var(--primary)' : '#eee';
        b.style.color = (i === n) ? 'white' : '#333';
    });
}

function updateCourse() {
    const v = document.getElementById('venue').value;
    const c = document.getElementById('course');
    c.innerHTML = '<option value="">è·é›¢ã‚’é¸æŠ</option>';
    if(v && db[v]) db[v].data.forEach((d,i) => {
        const o = document.createElement('option'); o.value = i; o.innerText = d.name; c.appendChild(o);
    });
}

function updateRecordDisplay() {
    const v = document.getElementById('venue').value;
    const i = document.getElementById('course').value;
    const info = document.getElementById('recInfo');
    if(v && i !== ""){
        const d = db[v].data[i];
        info.innerHTML = `ğŸ ãƒ¬ã‚³ãƒ¼ãƒ‰: <b>${Math.floor(d.record/60)}:${(d.record%60).toFixed(1).padStart(4,'0')}</b>`;
    }
}

function addEntry() {
    const name = document.getElementById('hName').value.trim();
    const num = document.getElementById('hNum').value || "0";
    const vKey = document.getElementById('venue').value;
    const cIdx = document.getElementById('course').value;
    const val = document.getElementById('rTime').value.trim();
    const rankVal = document.getElementById('rRank').value.trim();

    if(!name || !vKey || cIdx === "" || !val) return alert("å…¥åŠ›ä¸è¶³ï¼ˆé¦¬åãƒ»å ´æ‰€ãƒ»è·é›¢ãƒ»ã‚¿ã‚¤ãƒ ï¼‰");

    let isAbort = (val === "0" || val === "ä¸­æ­¢");
    let s = 0, tStr = "ä¸­æ­¢", ratio = "-";

    if(!isAbort) {
        if(val.includes(':')){
            const p = val.split(':');
            s = parseFloat(p[0])*60 + parseFloat(p[1]);
        } else {
            s = Math.floor(parseFloat(val)/100)*60 + (parseFloat(val)%100);
        }
        tStr = `${Math.floor(s/60)}:${(s%60).toFixed(1).padStart(4,'0')}`;
        ratio = ((s / db[vKey].data[cIdx].record) * 100).toFixed(2);
    }

    if(!horses[name]) horses[name] = { num: parseInt(num), results: [null, null, null, null, null] };
    horses[name].num = parseInt(num);
    horses[name].results[currentSlot] = {
        note: document.getElementById('rNote').value || "-",
        venueKey: vKey, distIdx: cIdx,
        time: tStr, ratio: ratio, rank: rankVal || "ä¸­æ­¢",
        weight: document.getElementById('rWeight').value || "-",
        cond: document.getElementById('rTrack').value,
        isAbort: isAbort
    };
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(horses));
    showToast("ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸ");
    render();
}

function render() {
    const tbody = document.getElementById('hTableBody');
    tbody.innerHTML = "";
    const sortedNames = Object.keys(horses).sort((a,b) => horses[a].num - horses[b].num);
    const cs = {"è‰¯":"#28a745","ç¨":"#8bc34a","é‡":"#ffc107","ä¸":"#f44336"};
    
    sortedNames.forEach(name => {
        const hData = horses[name];
        let tds = "";
        hData.results.forEach((h, idx) => {
            if(!h) {
                tds += `<td class="race-td"><div class="race-box" style="color:#ccc; display:flex; align-items:center; justify-content:center;">-</div></td>`;
            } else {
                let rClass = "", displayRatio = "";
                let displayTime = `<div class="r-time">${h.time}</div>`;
                
                let rankClass = "rank-other";
                if(h.rank == "1") rankClass = "rank-1";
                else if(h.rank == "2") rankClass = "rank-2";
                else if(h.rank == "3") rankClass = "rank-3";

                if(h.isAbort) {
                    displayTime = `<div class="r-abort">ä¸­æ­¢</div>`;
                    displayRatio = `<div class="r-ratio" style="background:#f3f4f6;">-</div>`;
                } else {
                    const r = parseFloat(h.ratio);
                    rClass = r < 101.5 ? 'best-yellow' : r < 103.0 ? 'best-blue' : r < 104.5 ? 'best-orange' : '';
                    displayRatio = `<div class="r-ratio ${rClass}">${h.ratio}%</div>`;
                }

                tds += `<td class="race-td"><div class="race-box">
                    <div style="position:absolute;top:2px;right:2px;color:#bbb;cursor:pointer;font-size:12px;" onclick="editSlot('${name}',${idx})">âœ</div>
                    <div class="r-note">${h.note}</div>
                    <span class="r-cond">${db[h.venueKey].label}${db[h.venueKey].data[h.distIdx].name}</span>
                    ${displayTime}
                    <div class="r-sub-info">
                        <span class="badge-cond" style="background:${cs[h.cond]}">${h.cond}</span>
                        <span class="badge-weight">${h.weight}</span>
                        <div class="rank-badge ${rankClass}">${h.rank}</div>
                    </div>
                    ${displayRatio}
                </div></td>`;
            }
        });
        tbody.innerHTML += `<tr><td class="horse-info-cell"><div><span class="h-num-badge">${hData.num}</span></div><div style="margin-top:4px; font-weight:bold;">${name}</div><div style="font-size:9px;color:#ff9999;cursor:pointer;margin-top:8px;" onclick="delHorse('${name}')">å‰Šé™¤</div></td>${tds}</tr>`;
    });
}

function editSlot(name, idx) {
    const h = horses[name].results[idx];
    document.getElementById('hName').value = name;
    document.getElementById('hNum').value = horses[name].num;
    document.getElementById('rNote').value = h.note;
    document.getElementById('venue').value = h.venueKey;
    updateCourse();
    document.getElementById('course').value = h.distIdx;
    updateRecordDisplay();
    document.getElementById('rRank').value = h.rank;
    document.getElementById('rWeight').value = h.weight;
    document.getElementById('rTime').value = h.isAbort ? "0" : h.time.replace(':','');
    document.getElementById('rTrack').value = h.cond;
    setSlot(idx);
    window.scrollTo(0,0);
}

function downloadJSON() { const blob = new Blob([JSON.stringify(horses)], {type: "application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `horse_data.json`; a.click(); }
function importData(event) { const reader = new FileReader(); reader.onload = (e) => { try { horses = JSON.parse(e.target.result); localStorage.setItem(STORAGE_KEY, JSON.stringify(horses)); render(); } catch(err){ alert("èª­è¾¼å¤±æ•—"); } }; reader.readAsText(event.target.files[0]); }
function delHorse(n){ if(confirm(n + "ã‚’å‰Šé™¤ï¼Ÿ")){ delete horses[n]; localStorage.setItem(STORAGE_KEY, JSON.stringify(horses)); render(); } }
function clearAll(){ if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")){ horses={}; localStorage.removeItem(STORAGE_KEY); render(); } }
</script>
</body>
</html>
