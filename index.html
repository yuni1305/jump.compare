<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éšœå®³é¦¬æŸ±åˆ†æï¼šé€£ç¶šæ•°å€¤å¯¾å¿œç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1b4332; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; font-size: 13px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
        h3 { margin: 0 0 10px 0; font-size: 14px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .ai-input-area { background: #eef2ff; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px dashed #4f46e5; }
        textarea { width: 100%; height: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; box-sizing: border-box; resize: none; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        label { display: block; font-size: 10px; font-weight: bold; color: #666; margin-bottom: 2px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .record-fixed-area { grid-column: span 2; background: #f8f9fa; border-left: 4px solid var(--primary); padding: 8px; border-radius: 4px; margin: 4px 0; font-size: 12px; }
        .outer-scroll { width: 100%; overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; padding: 5px; }
        .horse-table { border-collapse: collapse; min-width: 900px; width: 100%; background: white; }
        .th-slot { font-size: 14px; font-weight: bold; background: #f1f3f1; color: #1b4332; padding: 12px 5px; border-bottom: 2px solid #ddd; }
        .horse-name-cell { position: sticky; left: 0; z-index: 10; background: #333; color: white; width: 110px; min-width: 110px; padding: 10px 8px; text-align: center; border-bottom: 1px solid #444; border-right: 2px solid #222; font-weight: bold; font-size: 14px; }
        .race-box { padding: 8px 6px; text-align: center; min-height: 145px; position: relative; }
        .r-note { font-size: 12px; font-weight: bold; height: 32px; display: flex; align-items: center; justify-content: center; line-height: 1.1; }
        .r-time { font-size: 15px; font-weight: bold; color: #111; }
        .r-sub-info { font-size: 12px; margin: 2px 0; display: flex; justify-content: center; gap: 4px; align-items: center; }
        .badge-cond { color: white; padding: 1px 4px; border-radius: 3px; font-size: 10px; }
        .badge-weight { background: #f0f0f0; color: #444; border: 1px solid #ccc; padding: 0px 4px; border-radius: 3px; font-size: 10px; font-weight: bold; }
        .genryo-mark { color: #d32f2f; font-weight: bold; }
        .r-ratio { font-size: 14px; font-weight: bold; padding: 3px; border-radius: 4px; border: 1px solid #eee; display: block; margin-top: 4px; }
        .best-s { background: #fee2e2; color: #b91c1c; }
        .best-a { background: #ffedd5; color: #c2410c; }
        .best-b { background: #dcfce7; color: #15803d; }
        .admin-block { background: #fff; padding: 12px; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .admin-btn { padding: 12px 8px; border-radius: 4px; border: none; font-size: 11px; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="card ai-input-area">
        <h3>ğŸ“ æˆç¸¾ãƒ†ã‚­ã‚¹ãƒˆè§£æå…¥åŠ›</h3>
        <textarea id="aiRawText" placeholder="ã‚³ãƒ”ãƒ¼ã—ãŸæˆç¸¾ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘"></textarea>
        <button onclick="parseText()" style="width:100%; margin-top:5px; padding:12px; background:#4f46e5; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">AIè§£æã‚’å®Ÿè¡Œ</button>
    </div>

    <div class="card">
        <h3>ğŸ“Š ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h3>
        <div class="input-grid">
            <div style="grid-column: span 2;"><label>é¦¬å</label><input type="text" id="hName"></div>
            <div><label>ç«¶é¦¬å ´</label><select id="venue" onchange="updateCourse()"><option value="">é¸æŠ</option><option value="nakayama">ä¸­å±±</option><option value="tokyo">æ±äº¬</option><option value="kyoto">äº¬éƒ½</option><option value="hanshin">é˜ªç¥</option><option value="niigata">æ–°æ½Ÿ</option><option value="kokura">å°å€‰</option><option value="fukushima">ç¦å³¶</option><option value="chukyo">ä¸­äº¬</option></select></div>
            <div><label>è·é›¢</label><select id="course" onchange="updateRecordDisplay()"></select></div>
            <div id="recInfo" class="record-fixed-area">å ´æ‰€ã¨è·é›¢ã‚’é¸æŠ</div>
            <div><label>ãƒ¬ãƒ¼ã‚¹å</label><input type="text" id="rNote"></div>
            <div><label>ã‚¿ã‚¤ãƒ </label><input type="text" id="rTime" placeholder="3:27.1"></div>
            <div><label>ç€é †</label><input type="number" id="rRank"></div>
            <div><label>æ–¤é‡</label><input type="text" id="rWeight"></div>
            <div><label>é¦¬å ´</label><select id="rTrack"><option value="è‰¯">è‰¯</option><option value="ç¨">ç¨é‡</option><option value="é‡">é‡</option><option value="ä¸">ä¸è‰¯</option></select></div>
            <div style="grid-column: span 2; display: flex; gap: 4px;">
                <button class="slot-btn" style="flex:1; padding:8px;" onclick="setSlot(0)">1èµ°å‰</button>
                <button class="slot-btn" style="flex:1; padding:8px;" onclick="setSlot(1)">2èµ°å‰</button>
                <button class="slot-btn" style="flex:1; padding:8px;" onclick="setSlot(2)">3èµ°å‰</button>
                <button class="slot-btn" style="flex:1; padding:8px;" onclick="setSlot(3)">4èµ°å‰</button>
                <button class="slot-btn" style="flex:1; padding:8px;" onclick="setSlot(4)">5èµ°å‰</button>
            </div>
        </div>
        <button onclick="addEntry()" style="width:100%; margin-top:10px; padding:15px; background:var(--primary); color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ç™»éŒ²</button>
    </div>

    <div id="captureArea">
        <div class="outer-scroll">
            <table class="horse-table" id="mainTable">
                <thead>
                    <tr><th class="horse-name-cell">é¦¬å</th><th class="th-slot">1èµ°å‰</th><th class="th-slot">2èµ°å‰</th><th class="th-slot">3èµ°å‰</th><th class="th-slot">4èµ°å‰</th><th class="th-slot">5èµ°å‰</th></tr>
                </thead>
                <tbody id="hTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="admin-block">
        <button class="admin-btn" style="background:#2a6fdb" onclick="downloadJSON()">ğŸ“¤ JSONä¿å­˜</button>
        <button class="admin-btn" style="background:#34495e" onclick="document.getElementById('fileInput').click()">ğŸ“¥ JSONèª­è¾¼</button>
        <button class="admin-btn" style="background:#27ae60" onclick="downloadCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
        <button class="admin-btn" style="background:#8e44ad" onclick="saveAsImage()">ğŸ“¸ ç”»åƒä¿å­˜</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
        <button class="admin-btn" style="background:#e74c3c; grid-column:span 2" onclick="clearAll()">ğŸ’¥ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
    </div>
</div>

<script>
// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç•¥ (å¤‰æ›´ãªã—) ---
const db = {
    nakayama: { label: "ä¸­å±±", data: [{ name: "èŠ4260m", record: 290.5 }, { name: "èŠ4250m", record: 283.0 }, { name: "èŠ4100m", record: 276.1 }, { name: "èŠ3570m", record: 237.9 }, { name: "èŠ3370m", record: 225.4 }, { name: "èŠ3350m", record: 220.8 }, { name: "èŠ3210m", record: 209.3 }, { name: "èŠ3030m", record: 200.3 }, { name: "èŠ2710m", record: 182.2 }] },
    kyoto: { label: "äº¬éƒ½", data: [{ name: "èŠ3930m", record: 261.6 }, { name: "èŠ3180m", record: 213.5 }, { name: "èŠ3170m", record: 210.4 }, { name: "ãƒ€3170m", record: 208.4 }, { name: "ãƒ€2930m", record: 192.2 }, { name: "ãƒ€2910m", record: 191.2 }] },
    tokyo: { label: "æ±äº¬", data: [{ name: "èŠ3300m", record: 215.1 }, { name: "ãƒ€3300m", record: 216.2 }, { name: "èŠ3110m", record: 203.6 }] },
    hanshin: { label: "é˜ªç¥", data: [{ name: "èŠ3900m", record: 259.1 }, { name: "èŠ3140m", record: 204.8 }] },
    niigata: { label: "æ–°æ½Ÿ", data: [{ name: "èŠ3290m", record: 214.4 }, { name: "èŠ3250m", record: 208.3 }, { name: "èŠ2890m", record: 185.5 }, { name: "èŠ2850m", record: 181.4 }] },
    kokura: { label: "å°å€‰", data: [{ name: "èŠ3390m", record: 220.0 }, { name: "èŠ2900m", record: 187.1 }, { name: "èŠ2860m", record: 186.3 }] },
    fukushima: { label: "ç¦å³¶", data: [{ name: "èŠ3380m", record: 218.5 }, { name: "èŠ2800m", record: 181.8 }, { name: "èŠ2770m", record: 179.3 }, { name: "èŠ2750m", record: 177.2 }] },
    chukyo: { label: "ä¸­äº¬", data: [{ name: "èŠ3900m", record: 254.8 }, { name: "èŠ3330m", record: 217.4 }, { name: "èŠ3300m", record: 213.3 }, { name: "èŠ3000m", record: 195.8 }] }
};

let horses = {};
let currentSlot = 0;

function parseText() {
    const raw = document.getElementById('aiRawText').value;
    if(!raw) return;

    // 1. ã‚¿ã‚¤ãƒ ã®æŠ½å‡º (M:SS.S)
    const timeMatch = raw.match(/(\d)[:ï¼š](\d{2}\.\d)/);
    if(timeMatch) document.getElementById('rTime').value = timeMatch[0];

    // 2. æ–¤é‡ã®æŠ½å‡º (ã‚¿ã‚¤ãƒ ã®å‰ã®æ•°å€¤ã‚’é€†ç®—)
    // 60.05163:27.1 ã®ã‚ˆã†ãªå½¢ã‹ã‚‰ 60.0 ã‚’æ¢ã™
    const weightRegex = /([â–²â˜†â—‡â–³â˜…\+]{0,2})(\d{2}\.\d|\d{2})(?=\d{3}\d:|\s|$|kg)/;
    const weightMatch = raw.match(weightRegex);
    if(weightMatch) {
        document.getElementById('rWeight').value = weightMatch[1] + weightMatch[2];
    }

    // 3. ç«¶é¦¬å ´ã®åˆ¤å®š
    let vKey = "";
    for(const key in db) { if(raw.includes(db[key].label)) { vKey = key; document.getElementById('venue').value = key; updateCourse(); break; } }

    // 4. è·é›¢ã¨é¦¬å ´
    const distMatch = raw.match(/(\d{4})/);
    if(distMatch && vKey) {
        const dVal = distMatch[1];
        const isDirt = raw.includes("ãƒ€");
        const cs = document.getElementById('course');
        for(let i=0; i<cs.options.length; i++){
            if(cs.options[i].text.includes(dVal)){
                if(isDirt && cs.options[i].text.includes("ãƒ€")) { cs.selectedIndex = i; break; }
                if(!isDirt && cs.options[i].text.includes("èŠ")) { cs.selectedIndex = i; break; }
                cs.selectedIndex = i;
            }
        }
        updateRecordDisplay();
    }

    // 5. é¦¬å ´çŠ¶æ…‹
    const track = ["è‰¯","ç¨","é‡","ä¸"].find(t => raw.includes(t));
    if(track) document.getElementById('rTrack').value = track;

    // 6. ç€é † (è·é›¢ã®å¾Œã®æ•°å€¤ã‚’æ¨æ¸¬ã€‚ä»Šå›ã®å ´åˆã€Œ3110è‰¯1233ã€ã®ä¸­ã‹ã‚‰ç€é †ã‚’æ¢ã™)
    // é€šå¸¸ã€é€šéé †ãªã©ã®å¡Šã®ä¸­ã‹ã‚‰ã€Œæœ«å°¾ã®æ•°å­—ã€ã‚„ã€Œå˜ç‹¬ã®æ•°å­—ã€ã‚’ç€é †ã¨ã™ã‚‹
    const rankMatch = raw.match(/(?:[^\d])(\d)(?=[â–²â˜†â—‡â–³â˜…\+]|\d{2}\.\d\d{3}\d:|å°å‚|çŸ³ç¥|äº”ååµ)/) || raw.match(/(\d+)ç€/);
    if(rankMatch) document.getElementById('rRank').value = rankMatch[1];

    // 7. ãƒ¬ãƒ¼ã‚¹å
    const raceMatch = raw.match(/(?:æ±äº¬|ä¸­å±±|äº¬éƒ½|é˜ªç¥|æ–°æ½Ÿ|å°å€‰|ç¦å³¶|ä¸­äº¬)(.*?)(?:èŠ|ãƒ€|\d{4})/);
    if(raceMatch) document.getElementById('rNote').value = raceMatch[1].trim();

    alert("è§£æå®Œäº†ã€‚");
}

// --- ä»¥ä¸‹ã€æ—¢å­˜ã®ç®¡ç†ãƒ»æç”»é–¢æ•° (å‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ---
function setSlot(n) { currentSlot = n; document.querySelectorAll('.slot-btn').forEach((b,i) => { b.style.background = i===n ? '#4f46e5' : '#eee'; b.style.color = i===n ? 'white' : '#333'; }); }
function updateCourse() { const v = document.getElementById('venue').value; const c = document.getElementById('course'); c.innerHTML = '<option value="">è·é›¢</option>'; if(v && db[v]) db[v].data.forEach((d,i) => { const o = document.createElement('option'); o.value = i; o.innerText = d.name; c.appendChild(o); }); }
function updateRecordDisplay() { const v = document.getElementById('venue').value; const i = document.getElementById('course').value; if(v && i !== ""){ const d = db[v].data[i]; document.getElementById('recInfo').innerHTML = `ğŸ ãƒ¬ã‚³ãƒ¼ãƒ‰: <b>${Math.floor(d.record/60)}:${(d.record%60).toFixed(1).padStart(4,'0')}</b>`; } }
function addEntry() {
    const name = document.getElementById('hName').value.trim() || "æœªå…¥åŠ›";
    const vKey = document.getElementById('venue').value;
    const cIdx = document.getElementById('course').value;
    const val = document.getElementById('rTime').value.trim();
    if(!vKey || cIdx === "" || !val) return alert("å…¥åŠ›ä¸è¶³");
    let s = 0; if(val.includes(':')){ const p = val.split(':'); s = parseFloat(p[0])*60 + parseFloat(p[1]); }
    const ratio = (s / db[vKey].data[cIdx].record) * 100;
    if(!horses[name]) horses[name] = [null, null, null, null, null];
    horses[name][currentSlot] = { note: document.getElementById('rNote').value, venue: db[vKey].label, dist: db[vKey].data[cIdx].name, time: val, ratio: ratio.toFixed(2), rank: document.getElementById('rRank').value, weight: document.getElementById('rWeight').value, cond: document.getElementById('rTrack').value };
    localStorage.setItem('horseV15', JSON.stringify(horses)); render();
}
function render() {
    const tbody = document.getElementById('hTableBody'); tbody.innerHTML = "";
    const sorted = Object.keys(horses).sort((a,b) => a.localeCompare(b, 'ja'));
    const cs = {"è‰¯":"#28a745","ç¨":"#8bc34a","é‡":"#ffc107","ä¸":"#f44336"};
    sorted.forEach(name => {
        let tds = "";
        horses[name].forEach(h => {
            if(!h) { tds += `<td><div class="race-box">-</div></td>`; }
            else {
                const r = parseFloat(h.ratio); let rClass = r < 101.5 ? 'best-s' : r < 103.0 ? 'best-a' : r < 104.5 ? 'best-b' : '';
                const wM = h.weight.match(/^([â–²â˜†â—‡â–³â˜…\+]+)?(.*)$/);
                tds += `<td><div class="race-box"><div class="r-note">${h.note}</div><div class="r-cond">${h.venue}${h.dist}</div><div class="r-time">${h.time}</div><div class="r-sub-info"><span class="badge-cond" style="background:${cs[h.cond]}">${h.cond}</span><span class="badge-weight"><span class="genryo-mark">${wM[1]||""}</span>${wM[2]}kg</span><b>${h.rank}ç€</b></div><div class="r-ratio ${rClass}">${h.ratio}%</div></div></td>`;
            }
        });
        tbody.innerHTML += `<tr><td class="horse-name-cell">${name}<div style="font-size:9px;color:#ff9999;cursor:pointer;" onclick="delHorse('${name}')">å‰Šé™¤</div></td>${tds}</tr>`;
    });
}
function delHorse(n){ if(confirm("å‰Šé™¤ï¼Ÿ")){ delete horses[n]; localStorage.setItem('horseV15', JSON.stringify(horses)); render(); } }
function downloadJSON(){ const b = new Blob([JSON.stringify(horses)], {type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(b); a.download="horse.json"; a.click(); }
function importData(e){ const r=new FileReader(); r.onload=(ev)=>{ horses=JSON.parse(ev.target.result); render(); }; r.readAsText(e.target.files[0]); }
function downloadCSV() { let csv = "\uFEFFé¦¬å,èµ°å‰,ãƒ¬ãƒ¼ã‚¹,ã‚³ãƒ¼ã‚¹,ã‚¿ã‚¤ãƒ ,ç€é †,æ–¤é‡,é¦¬å ´,æ¯”ç‡\n"; for(const n in horses){ horses[n].forEach((h,i)=>{ if(h) csv+=`${n},${i+1},${h.note},${h.venue}${h.dist},${h.time},${h.rank},${h.weight},${h.cond},${h.ratio}%\n`}); } const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"})); a.download="horse.csv"; a.click(); }
function saveAsImage() { html2canvas(document.getElementById('captureArea')).then(canvas => { const a = document.createElement("a"); a.href = canvas.toDataURL(); a.download = "horse.png"; a.click(); }); }
function clearAll(){ if(confirm("å…¨æ¶ˆå»ï¼Ÿ")){ horses={}; localStorage.clear(); render(); } }
window.onload = () => { const s = localStorage.getItem('horseV15'); if(s){ horses=JSON.parse(s); render(); } setSlot(0); };
</script>
</body>
</html>
