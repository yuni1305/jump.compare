<script>
// --- 修正した parseText 関数のみ抜粋 ---
function parseText() {
    const raw = document.getElementById('aiRawText').value;
    if(!raw) return;

    // 1. 競馬場の判定
    let foundVenue = "";
    for(const key in db) {
        if(raw.includes(db[key].label)) {
            document.getElementById('venue').value = key;
            foundVenue = key;
            updateCourse();
            break;
        }
    }

    // 2. 距離と馬場(芝/ダ)の抽出ロジックを大幅強化
    const distMatch = raw.match(/(\d{4})/); // 3170 などの4桁
    if(distMatch && foundVenue) {
        const distVal = distMatch[1];
        const isDirt = raw.includes("ダ"); // "芝ダ" でも "ダ" があればダート優先
        const isTurf = raw.includes("芝") && !isDirt;

        const cs = document.getElementById('course');
        let targetIndex = -1;

        // 候補の中から「距離」と「芝/ダ」の両方が合致するものを探す
        for(let i=0; i<cs.options.length; i++) {
            const optText = cs.options[i].text;
            if(optText.includes(distVal)) {
                if(isDirt && optText.includes("ダ")) { targetIndex = i; break; }
                if(isTurf && optText.includes("芝")) { targetIndex = i; break; }
                // 指定がない場合は最初に見つかった距離に一致するものをキープ
                if(targetIndex === -1) targetIndex = i;
            }
        }
        
        if(targetIndex !== -1) {
            cs.selectedIndex = targetIndex;
            updateRecordDisplay();
        }
    }

    // --- 以下、タイム・着順・斤量・馬場状態の既存ロジック ---
    // タイム
    const timeMatch = raw.match(/(\d)[:：](\d{2}\.\d)/);
    if(timeMatch) document.getElementById('rTime').value = timeMatch[0];
    // 着順
    const rankMatch = raw.match(/(\d+)\s*着/);
    if(rankMatch) document.getElementById('rRank').value = rankMatch[1];
    // 斤量
    const weightMatch = raw.match(/([▲☆◇△★\+]{0,2})(\d{2}\.\d|\d{2})(kg|キロ)?/);
    if(weightMatch) document.getElementById('rWeight').value = weightMatch[1] + weightMatch[2];
    // 馬場状態 (良/稍重など)
    if(raw.includes("稍重") || raw.includes("稍")) document.getElementById('rTrack').value = "稍";
    else if(raw.includes("不")) document.getElementById('rTrack').value = "不";
    else if(raw.includes("重")) document.getElementById('rTrack').value = "重";
    else if(raw.includes("良")) document.getElementById('rTrack').value = "良";

    // レース名
    const raceMatch = raw.match(/(?:東京|中山|京都|阪神|新潟|小倉|福島|中京)(.*?)(?:\d+着)/);
    if(raceMatch) {
        let name = raceMatch[1].replace(/\d+頭.*/, "").replace(/\d{4}\S+/, "").trim();
        document.getElementById('rNote').value = name || "障害戦";
    }

    alert("解析完了：距離と馬場（芝/ダ）を優先判別しました。");
}
</script>
