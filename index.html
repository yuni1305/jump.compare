<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÈöúÂÆ≥È¶¨Êü±ÂàÜÊûê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1b4332; --accent: #2d6a4f; --bg: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; font-size: 13px; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* „Çø„Ç§„Éà„É´ÂÖ•ÂäõÊ¨Ñ„ÅÆ„Çπ„Çø„Ç§„É´ */
        .title-card { background: var(--primary); color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .title-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 18px; font-weight: bold; text-align: center; width: 100%; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        .title-input::placeholder { color: rgba(255,255,255,0.5); }

        .card { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 4px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
        .choice-btn { flex: 1; min-width: 50px; padding: 8px 4px; border: 1px solid #ddd; background: #fff; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; color: #333; display: flex; align-items: center; justify-content: center; }
        .choice-btn:active { transform: translateY(2px); }
        .choice-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .dist-btn { background: #e9ecef; border: none; font-size: 11px; }
        .dist-btn.active { background: #3d85c6; color: white; }
        .step-btn { background: #f8f9fa; border-color: #ccc; font-weight: bold; font-size: 14px; }
        .quick-text-btn { background: #fff3e0; border-color: #ffcc80; color: #e65100; font-weight: bold; }
        .record-fixed-area { grid-column: span 2; background: #eef2f3; border-left: 4px solid var(--primary); padding: 8px; border-radius: 4px; font-size: 12px; min-height: 1.2em; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .outer-scroll { width: 100%; overflow-x: auto; background: white; border-radius: 8px; margin-bottom: 10px; padding: 5px; }
        .horse-table { border-collapse: collapse; min-width: 950px; width: 100%; }
        .horse-info-cell { position: sticky; left: 0; z-index: 10; background: #333; color: white; width: 120px; padding: 8px; text-align: center; border-bottom: 1px solid #444; }
        .race-td { border-bottom: 1px solid #eee; border-right: 1px solid #ddd; width: 170px; padding: 0; vertical-align: top; }
        .race-box { padding: 8px 6px; text-align: center; min-height: 145px; position: relative; }
        .r-note-disp { font-size: 13px; font-weight: bold; height: 36px; display: flex; align-items: center; justify-content: center; border: 1.5px solid #1b4332; border-radius: 4px; margin-bottom: 4px; background: #fff; line-height: 1.2; padding: 2px; }
        .special-race { background: #e6fffa; border: 2.5px solid #065f46; }
        .r-time { font-size: 16px; font-weight: bold; margin: 2px 0; }
        .rank-badge { min-width: 32px; height: 22px; padding: 0 4px; border-radius: 11px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; border: 1px solid #ccc; white-space: nowrap; background: #fff; }
        .rank-1 { background: #ffd700; color: #000; border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .rank-2 { background: #c0c0c0; color: #000; border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .rank-3 { background: #cd7f32; color: #fff; border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .r-ratio { font-size: 14px; font-weight: bold; padding: 3px; border-radius: 4px; display: block; margin-top: 5px; border: 1px solid #eee; }
        .best-yellow { background: #fef08a; color: #854d0e; }
        .best-blue { background: #dbeafe; color: #1e40af; }
        .best-orange { background: #ffedd5; color: #9a3412; }
        .admin-block { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .admin-btn { padding: 10px 2px; border-radius: 4px; border: none; font-size: 10px; color: white; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
    <div class="title-card">
        <label style="color: rgba(255,255,255,0.8); margin-bottom: 5px;">ÂàÜÊûêÂØæË±°„É¨„Éº„ÇπÂêç</label>
        <input type="text" id="targetRaceName" class="title-input" placeholder="‰æãÔºö‰∏≠Â±±„Ç∞„É©„É≥„Éâ„Ç∏„É£„É≥„Éó" oninput="saveTitle()">
    </div>

    <div class="card">
        <div class="input-grid">
            <div><label>È¶¨Áï™</label><input type="number" id="hNum" placeholder="5"></div>
            <div><label>È¶¨Âêç</label><input type="text" id="hName" placeholder="È¶¨Âêç"></div>
            
            <div style="grid-column: span 2;">
                <label>ÈÅéÂéªËµ∞„ÅÆÂ†¥ÊâÄ</label>
                <div class="btn-group" id="venueGroup"></div>
                <div class="btn-group" id="distGroup" style="min-height: 32px;"></div>
                <input type="hidden" id="venue">
                <input type="hidden" id="course">
            </div>

            <div id="recInfo" class="record-fixed-area">Â†¥ÊâÄ„Å®Ë∑ùÈõ¢„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>

            <div style="grid-column: span 2;">
                <label>ÈÅéÂéªËµ∞„ÅÆ„É¨„Éº„ÇπÂêç</label>
                <input type="text" id="rNote" placeholder="„É¨„Éº„ÇπÂêç„ÇíÂÖ•Âäõ" style="margin-bottom: 4px;">
                <div class="btn-group">
                    <button type="button" class="choice-btn quick-text-btn" onclick="quickRace('Êú™ÂãùÂà©')">Êú™ÂãùÂà©</button>
                    <button type="button" class="choice-btn quick-text-btn" onclick="quickRace('OP')">OP</button>
                    <button type="button" class="choice-btn quick-text-btn" onclick="appendJS()">ÔºãJS</button>
                </div>
            </div>

            <div><label>ÁùÄÈ†Ü</label>
                <input type="text" id="rRank" inputmode="numeric" value="1" style="text-align: center; font-weight: bold; margin-bottom: 4px;">
                <div style="display: flex; gap: 2px;">
                    <button type="button" class="choice-btn step-btn" onclick="stepInput('rRank', -1)">-1</button>
                    <button type="button" class="choice-btn step-btn" onclick="stepInput('rRank', 1)">+1</button>
                </div>
            </div>
            
            <div><label>„Çø„Ç§„É† (‰æã: 3452)</label><input type="text" id="rTime" inputmode="numeric" placeholder="3:45.2"></div>
            
            <div><label>È¶¨Â†¥</label><select id="rTrack"><option>ËâØ</option><option>Á®ç</option><option>Èáç</option><option>‰∏ç</option></select></div>
            
            <div><label>Êñ§Èáè</label>
                <input type="text" id="rWeight" value="60" style="text-align: center; background: #fffbe6; font-weight: bold; font-size: 18px; margin-bottom: 4px;">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px;">
                    <button type="button" class="choice-btn step-btn" onclick="stepInput('rWeight', -1)">-1</button>
                    <button type="button" class="choice-btn step-btn" onclick="stepInput('rWeight', -0.5)">-0.5</button>
                    <button type="button" class="choice-btn step-btn" onclick="stepInput('rWeight', 0.5)">+0.5</button>
                    <button type="button" class="choice-btn step-btn" onclick="stepInput('rWeight', 1)">+1</button>
                </div>
            </div>

            <div style="grid-column: span 2; display: flex; gap: 4px; margin-top: 5px;">
                <button class="choice-btn slot-btn active" onclick="setSlot(0)">1Ëµ∞Ââç</button>
                <button class="choice-btn slot-btn" onclick="setSlot(1)">2Ëµ∞Ââç</button>
                <button class="choice-btn slot-btn" onclick="setSlot(2)">3Ëµ∞Ââç</button>
                <button class="choice-btn slot-btn" onclick="setSlot(3)">4Ëµ∞Ââç</button>
                <button class="choice-btn slot-btn" onclick="setSlot(4)">5Ëµ∞Ââç</button>
            </div>
        </div>
        <button onclick="addEntry()" style="width:100%; margin-top:15px; padding:15px; background:var(--primary); color:white; border:none; border-radius:4px; font-weight:bold; font-size:16px;">ÁôªÈå≤„Åó„Å¶Ë°®Á§∫„ÇíÊõ¥Êñ∞</button>
    </div>

    <div id="captureArea" style="background: white; padding: 10px; border-radius: 8px;">
        <h2 id="displayTitle" style="text-align:center; color:var(--primary); margin: 5px 0 15px 0;">ÂàÜÊûê„Ç∑„Éº„Éà</h2>
        <div class="outer-scroll">
            <table class="horse-table">
                <thead>
                    <tr>
                        <th class="horse-info-cell" style="background:#f1f3f1; color:#1b4332">È¶¨Áï™ / È¶¨Âêç</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd; color: #1b4332; font-weight: bold;">1Ëµ∞Ââç</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd; color: #1b4332; font-weight: bold;">2Ëµ∞Ââç</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd; color: #1b4332; font-weight: bold;">3Ëµ∞Ââç</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd; color: #1b4332; font-weight: bold;">4Ëµ∞Ââç</th>
                        <th style="padding:10px; border-bottom:2px solid #ddd; color: #1b4332; font-weight: bold;">5Ëµ∞Ââç</th>
                    </tr>
                </thead>
                <tbody id="hTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="admin-block">
        <button class="admin-btn" style="background:#2a6fdb" onclick="downloadJSON()">JSON</button>
        <button class="admin-btn" style="background:#27ae60" onclick="downloadCSV()">CSV</button>
        <button class="admin-btn" style="background:#34495e" onclick="document.getElementById('fileInput').click()">Ë™≠Ëæº</button>
        <button class="admin-btn" style="background:#8e44ad" onclick="saveAsImage()">ÁîªÂÉè</button>
        <button class="admin-btn" style="background:#e74c3c" onclick="clearAll()">Ê∂àÂéª</button>
        <input type="file" id="fileInput" style="display:none" onchange="importData(event)">
    </div>
</div>

<script>
const db = {
    nakayama: { label: "‰∏≠Â±±", data: [{ name: "Ëäù4260m", record: 290.5 }, { name: "Ëäù4250m", record: 283.0 }, { name: "Ëäù4100m", record: 276.1 }, { name: "Ëäù3570m", record: 237.9 }, { name: "„ÉÄ3550m", record: 238.1 }, { name: "Ëäù3370m", record: 225.4 }, { name: "Ëäù3350m", record: 220.8 }, { name: "Ëäù3210m", record: 209.3 }, { name: "„ÉÄ3200m", record: 211.0 }, { name: "Ëäù3030m", record: 200.3 }, { name: "„ÉÄ2880m", record: 190.2 }, { name: "Ëäù2710m", record: 182.2 }, { name: "„ÉÄ2700m", record: 176.8 }] },
    tokyo: { label: "Êù±‰∫¨", data: [{ name: "Ëäù3300m", record: 215.1 }, { name: "„ÉÄ3300m", record: 216.2 }, { name: "Ëäù3110m", record: 203.6 }, { name: "„ÉÄ3100m", record: 202.0 }, { name: "„ÉÄ3000m", record: 197.5 }] },
    kyoto: { label: "‰∫¨ÈÉΩ", data: [{ name: "Ëäù3930m", record: 261.6 }, { name: "„ÉÄ3790m", record: 255.0 }, { name: "„ÉÄ3760m", record: 254.4 }, { name: "„ÉÄ3190m", record: 211.5 }, { name: "Ëäù3180m", record: 213.5 }, { name: "Ëäù3170m", record: 210.4 }, { name: "„ÉÄ3170m", record: 208.4 }, { name: "„ÉÄ2930m", record: 192.2 }, { name: "„ÉÄ2910m", record: 191.2 }] },
    hanshin: { label: "Èò™Á•û", data: [{ name: "Ëäù3900m", record: 259.1 }, { name: "Ëäù3800m", record: 258.1 }, { name: "Ëäù3140m", record: 204.8 }, { name: "„ÉÄ3110m", record: 205.0 }, { name: "„ÉÄ2970m", record: 195.7 }] },
    chukyo: { label: "‰∏≠‰∫¨", data: [{ name: "Ëäù3900m", record: 254.8 }, { name: "Ëäù3330m", record: 217.4 }, { name: "Ëäù3300m", record: 213.3 }, { name: "Ëäù3000m", record: 195.8 }] },
    niigata: { label: "Êñ∞ÊΩü", data: [{ name: "Ëäù3290m", record: 214.4 }, { name: "Ëäù3250m", record: 208.3 }, { name: "Ëäù2890m", record: 185.5 }, { name: "Ëäù2850m", record: 181.4 }] },
    kokura: { label: "Â∞èÂÄâ", data: [{ name: "Ëäù3390m", record: 220.0 }, { name: "Ëäù2900m", record: 187.1 }, { name: "Ëäù2860m", record: 186.3 }] },
    fukushima: { label: "Á¶èÂ≥∂", data: [{ name: "Ëäù3380m", record: 218.5 }, { name: "Ëäù3350m", record: 219.0 }, { name: "Ëäù2800m", record: 181.8 }, { name: "Ëäù2770m", record: 179.3 }, { name: "Ëäù2750m", record: 177.2 }] }
};

let horses = {};
let currentSlot = 0;
const STORAGE_KEY = 'horse_v23_title';

window.onload = () => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved) { try { horses = JSON.parse(saved); render(); } catch(e) {} }
    const savedTitle = localStorage.getItem(STORAGE_KEY + '_title');
    if(savedTitle) {
        document.getElementById('targetRaceName').value = savedTitle;
        document.getElementById('displayTitle').innerText = savedTitle;
    }
    initVenueButtons();
};

function saveTitle() {
    const t = document.getElementById('targetRaceName').value;
    document.getElementById('displayTitle').innerText = t || "ÂàÜÊûê„Ç∑„Éº„Éà";
    localStorage.setItem(STORAGE_KEY + '_title', t);
}

function initVenueButtons() {
    const group = document.getElementById('venueGroup');
    group.innerHTML = "";
    for(let key in db) {
        group.innerHTML += `<button class="choice-btn venue-btn" onclick="selectVenue('${key}', this)">${db[key].label}</button>`;
    }
}

function selectVenue(key, btn) {
    document.querySelectorAll('.venue-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('venue').value = key;
    const distGroup = document.getElementById('distGroup');
    distGroup.innerHTML = "";
    db[key].data.forEach((d, i) => {
        distGroup.innerHTML += `<button class="choice-btn dist-btn" onclick="selectDist(${i}, this)">${d.name}</button>`;
    });
}

function selectDist(idx, btn) {
    document.querySelectorAll('.dist-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('course').value = idx;
    const v = document.getElementById('venue').value;
    const d = db[v].data[idx];
    document.getElementById('recInfo').innerHTML = `üèÅ „É¨„Ç≥„Éº„Éâ: <b>${Math.floor(d.record/60)}:${(d.record%60).toFixed(1).padStart(4,'0')}</b>`;
}

function quickRace(txt) { document.getElementById('rNote').value = txt; }
function appendJS() { const el = document.getElementById('rNote'); el.value = el.value + "JS"; }

function stepInput(id, val) {
    const el = document.getElementById(id);
    let cur = parseFloat(el.value) || 0;
    if (id === 'rRank' && cur + val < 1) return;
    el.value = (Math.round((cur + val) * 10) / 10);
}

document.getElementById('rTime').addEventListener('blur', function(e) {
    let v = e.target.value.replace(/[^0-9]/g, '');
    if (v.length >= 3) {
        let ms = v.slice(-1), sec = v.slice(-3, -1), min = v.slice(0, -3) || "0";
        e.target.value = `${min}:${sec}.${ms}`;
    }
});

function setSlot(n) {
    currentSlot = n;
    document.querySelectorAll('.slot-btn').forEach((b,i) => {
        if(i === n) b.classList.add('active'); else b.classList.remove('active');
    });
}

function addEntry() {
    const name = document.getElementById('hName').value.trim();
    const num = document.getElementById('hNum').value || "0";
    const vKey = document.getElementById('venue').value;
    const cIdx = document.getElementById('course').value;
    const val = document.getElementById('rTime').value.trim();

    if(!name || !vKey || cIdx === "" || !val) return alert("ÂÖ•Âäõ‰∏çË∂≥ÔºàÂ†¥ÊâÄ„ÉªË∑ùÈõ¢„Éª„Çø„Ç§„É†„ÅØÂøÖÈ†àÔºâ");

    let isAbort = (val === "0" || val === "‰∏≠Ê≠¢"), s = 0, tStr = "‰∏≠Ê≠¢", ratio = "-";
    if(!isAbort) {
        const p = val.replace('.', ':').split(':');
        if(p.length === 2) s = parseFloat(p[0])*60 + parseFloat(p[1]);
        else if(p.length === 3) s = parseFloat(p[0])*60 + parseFloat(p[1]) + parseFloat(p[2])/10;
        else s = parseFloat(val);
        tStr = `${Math.floor(s/60)}:${(s%60).toFixed(1).padStart(4,'0')}`;
        ratio = ((s / db[vKey].data[cIdx].record) * 100).toFixed(2);
    }

    if(!horses[name]) horses[name] = { num: parseInt(num), results: [null, null, null, null, null] };
    horses[name].num = parseInt(num);
    horses[name].results[currentSlot] = {
        note: document.getElementById('rNote').value || "-",
        venueKey: vKey, distIdx: cIdx,
        time: tStr, ratio: ratio, rank: document.getElementById('rRank').value || "-",
        weight: document.getElementById('rWeight').value || "-",
        cond: document.getElementById('rTrack').value,
        isAbort: isAbort
    };
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(horses));
    showToast(`${currentSlot + 1}Ëµ∞Ââç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
    render();
}

function render() {
    const tbody = document.getElementById('hTableBody');
    tbody.innerHTML = "";
    const sortedNames = Object.keys(horses).sort((a,b) => horses[a].num - horses[b].num);
    const cs = {"ËâØ":"#28a745","Á®ç":"#8bc34a","Èáç":"#ffc107","‰∏ç":"#f44336"};
    
    sortedNames.forEach(name => {
        const hData = horses[name];
        let tds = "";
        hData.results.forEach((h, idx) => {
            if(!h) {
                tds += `<td class="race-td"><div class="race-box" style="color:#ccc; display:flex; align-items:center; justify-content:center;">-</div></td>`;
            } else {
                let rClass = "", displayTime = `<div class="r-time">${h.time}</div>`;
                let rankClass = (h.rank == "1") ? "rank-1" : (h.rank == "2") ? "rank-2" : (h.rank == "3") ? "rank-3" : "";
                let rankText = h.rank + (isNaN(h.rank) ? "" : "ÁùÄ");

                if(h.isAbort) {
                    displayTime = `<div style="color:#d32f2f; font-weight:bold; font-size:16px; margin: 2px 0;">‰∏≠Ê≠¢</div>`;
                    rankText = h.rank;
                } else {
                    const r = parseFloat(h.ratio);
                    rClass = r < 101.5 ? 'best-yellow' : r < 103.0 ? 'best-blue' : r < 104.5 ? 'best-orange' : '';
                }

                tds += `<td class="race-td"><div class="race-box">
                    <div style="position:absolute;top:2px;right:2px;color:#bbb;cursor:pointer;font-size:12px;" onclick="editSlot('${name}',${idx})">‚úé</div>
                    <div class="r-note-disp ${h.note.includes('Êú™ÂãùÂà©') || h.note.includes('OP') ? '' : 'special-race'}">${h.note}</div>
                    <span style="font-size:11px; color:#666;">${db[h.venueKey].label}${db[h.venueKey].data[h.distIdx].name}</span>
                    ${displayTime}
                    <div style="font-size:12px; display:flex; justify-content:center; gap:5px; align-items:center; margin-top:2px;">
                        <span style="background:${cs[h.cond]}; color:white; padding:1px 5px; border-radius:3px; font-size:10px;">${h.cond}</span>
                        <span style="font-weight:bold; color:#444;">${h.weight}</span>
                        <div class="rank-badge ${rankClass}">${rankText}</div>
                    </div>
                    <div class="r-ratio ${rClass}">${h.isAbort ? '-' : h.ratio + '%'}</div>
                </div></td>`;
            }
        });
        tbody.innerHTML += `<tr><td class="horse-info-cell"><div><span style="background:white; color:black; padding:1px 6px; border-radius:4px; font-weight:bold;">${hData.num}</span></div><div style="margin-top:4px; font-weight:bold;">${name}</div><div style="font-size:9px;color:#ff9999;cursor:pointer;margin-top:8px;" onclick="delHorse('${name}')">ÂâäÈô§</div></td>${tds}</tr>`;
    });
}

function editSlot(name, idx) {
    const h = horses[name].results[idx];
    document.getElementById('hName').value = name;
    document.getElementById('hNum').value = horses[name].num;
    document.getElementById('rNote').value = h.note;
    const vBtn = Array.from(document.querySelectorAll('.venue-btn')).find(b => b.innerText === db[h.venueKey].label);
    if(vBtn) selectVenue(h.venueKey, vBtn);
    setTimeout(() => {
        const dBtns = document.querySelectorAll('.dist-btn');
        const targetName = db[h.venueKey].data[h.distIdx].name;
        dBtns.forEach(btn => { if(btn.innerText === targetName) selectDist(h.distIdx, btn); });
    }, 50);
    document.getElementById('rRank').value = h.rank;
    document.getElementById('rWeight').value = h.weight;
    document.getElementById('rTime').value = h.isAbort ? "0" : h.time;
    document.getElementById('rTrack').value = h.cond;
    setSlot(idx);
    window.scrollTo(0,0);
}

function downloadCSV() {
    const raceTitle = document.getElementById('targetRaceName').value || "analysis";
    if (Object.keys(horses).length === 0) return alert("„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
    let csv = "\ufeffÈ¶¨Áï™,È¶¨Âêç,";
    for(let i=1; i<=5; i++) csv += `${i}Ëµ∞Ââç_„É¨„Éº„Çπ,${i}Ëµ∞Ââç_Â†¥ÊâÄË∑ùÈõ¢,${i}Ëµ∞Ââç_„Çø„Ç§„É†,${i}Ëµ∞Ââç_ÁùÄÈ†Ü,${i}Ëµ∞Ââç_Êñ§Èáè,${i}Ëµ∞Ââç_ÊØîÁéá,`;
    csv += "\n";
    const sorted = Object.keys(horses).sort((a,b) => horses[a].num - horses[b].num);
    sorted.forEach(name => {
        const h = horses[name];
        let row = `${h.num},${name},`;
        h.results.forEach(res => {
            if(res) {
                const loc = db[res.venueKey].label + db[res.venueKey].data[res.distIdx].name;
                row += `"${res.note}","${loc}","${res.time}","${res.rank}","${res.weight}","${res.ratio}%",`;
            } else row += ",,,,,,";
        });
        csv += row + "\n";
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${raceTitle}.csv`;
    a.click();
}

function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = "1"; setTimeout(() => t.style.opacity = "0", 2000); }
function downloadJSON() { 
    const raceTitle = document.getElementById('targetRaceName').value || "horse_data";
    const blob = new Blob([JSON.stringify(horses)], {type: "application/json"}); 
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${raceTitle}.json`; a.click(); 
}
function importData(event) { 
    const reader = new FileReader(); 
    reader.onload = (e) => { 
        try { 
            horses = JSON.parse(e.target.result); 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(horses)); 
            render(); 
        } catch(err){ alert("ÂΩ¢Âºè„Ç®„É©„Éº"); } 
    }; 
    reader.readAsText(event.target.files[0]); 
}
function saveAsImage() { 
    const raceTitle = document.getElementById('targetRaceName').value || "analysis";
    html2canvas(document.getElementById('captureArea')).then(canvas => { 
        const a = document.createElement("a"); a.href = canvas.toDataURL(); a.download = `${raceTitle}.png`; a.click(); 
    }); 
}
function delHorse(n){ if(confirm(n + "„ÇíÂâäÈô§Ôºü")){ delete horses[n]; localStorage.setItem(STORAGE_KEY, JSON.stringify(horses)); render(); } }
function clearAll(){ if(confirm("ÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü")){ horses={}; localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(STORAGE_KEY + '_title'); document.getElementById('targetRaceName').value=""; render(); } }
</script>
</body>
</html>
